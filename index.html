<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Number Roll Game</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ffffff" />

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7fb; color: #111; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 18px; }
    .card { background: white; border-radius: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.08); padding: 18px; }
    h1 { margin: 8px 0 2px; font-size: 30px; }
    .sub { margin: 0 0 14px; color: #555; }

    .row { display: flex; gap: 12px; }
    .col { flex: 1; }

    button {
      border: 0;
      border-radius: 14px;
      padding: 14px 12px;
      font-size: 16px;
      font-weight: 650;
      cursor: pointer;
    }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .btn-primary { background: #111; color: #fff; }
    .btn-outline { background: #fff; color: #111; border: 2px solid #111; }
    .btn-ghost { background: transparent; color: #111; }

    .center { text-align: center; }
    .gold { font-size: 44px; font-weight: 800; color: #c58b00; user-select: none; }
    .gold.small { font-size: 22px; }
    .hint { font-size: 13px; color: #666; margin-top: 6px; }

    .bigNum { font-size: 72px; font-weight: 900; color: #1f62ff; line-height: 1; margin: 6px 0 0; }
    .turn { font-size: 22px; font-weight: 750; margin-top: 10px; }
    .last { color: #555; margin-top: 6px; }

    .diceBtn {
      width: 128px; height: 128px;
      border-radius: 999px;
      background: #111; color: #fff;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 44px;
    }
    .spin { animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }

    .history { margin-top: 16px; }
    .histRow { display:flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px; }
    .roll1 { color: #c40000; font-weight: 800; }
    .ok { color: #0b7a00; font-weight: 800; }

    .stack { display:flex; flex-direction: column; gap: 10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="center">
      <h1>Number Roll Game</h1>
      <p class="sub" id="subtitle">Choose your game mode</p>
    </div>

    <div class="card" id="screen"></div>

    <div class="card history" id="historyCard" style="display:none;">
      <div style="font-weight:800; margin-bottom: 8px;">Game History</div>
      <div id="historyList" style="max-height:200px; overflow:auto;"></div>
    </div>
  </div>

<script>
(() => {
  // ---------- persistence ----------
  const KEY = "numbergame_save_v1";
  const load = () => {
    try { return JSON.parse(localStorage.getItem(KEY) || "{}"); }
    catch { return {}; }
  };
  const save = (state) => {
    try { localStorage.setItem(KEY, JSON.stringify(state)); } catch {}
  };

  // ---------- state ----------
  const saved = load();
  let gameMode = saved.gameMode ?? null;     // "pvp" | "ai" | null
  let currentNumber = saved.currentNumber ?? 100;
  let currentPlayer = saved.currentPlayer ?? 1; // 1|2
  let gameOver = saved.gameOver ?? false;
  let loser = saved.loser ?? null;           // 1|2|null
  let lastRoll = saved.lastRoll ?? null;
  let history = Array.isArray(saved.history) ? saved.history : [];
  let gold = Number.isFinite(saved.gold) ? saved.gold : 5;
  let currentBet = saved.currentBet ?? 0;
  let showBettingScreen = saved.showBettingScreen ?? false;
  let isRolling = false;
  let aiTimeout = null;

  // ---------- helpers ----------
  const $screen = document.getElementById("screen");
  const $subtitle = document.getElementById("subtitle");
  const $historyCard = document.getElementById("historyCard");
  const $historyList = document.getElementById("historyList");

  const persist = () => save({
    gameMode, currentNumber, currentPlayer, gameOver, loser, lastRoll,
    history, gold, currentBet, showBettingScreen
  });

  const resetToMenu = () => {
    clearTimeout(aiTimeout);
    gameMode = null;
    currentNumber = 100;
    currentPlayer = 1;
    gameOver = false;
    loser = null;
    lastRoll = null;
    history = [];
    currentBet = 0;
    showBettingScreen = false;
    persist();
    render();
  };

  const startGame = (mode) => {
    clearTimeout(aiTimeout);
    gameMode = mode;
    gameOver = false;
    loser = null;
    lastRoll = null;
    history = [];
    currentNumber = 100;
    currentPlayer = 1;

    if (mode === "ai") {
      showBettingScreen = true;
    } else {
      showBettingScreen = false;
    }
    persist();
    render();
  };

  const selectBet = (betAmount) => {
    if (!betAmount || betAmount <= 0) return;
    currentBet = betAmount;
    currentNumber = 100;
    currentPlayer = 1;
    gameOver = false;
    loser = null;
    lastRoll = null;
    history = [];
    showBettingScreen = false;
    persist();
    render();
  };

  const restoreGold = () => {
    if (gold < 5) gold = 5;
    persist();
    render();
  };

  const rollOnce = (player) => {
    const roll = Math.floor(Math.random() * currentNumber) + 1;
    lastRoll = roll;
    history = [...history, { player, roll }];

    if (roll === 1) {
      gameOver = true;
      loser = player;
      if (gameMode === "ai") {
        if (player === 2) gold += currentBet; // you win
        else gold -= currentBet;              // you lose
      }
    } else {
      currentNumber = roll;
      currentPlayer = (player === 1 ? 2 : 1);
    }
    persist();
  };

  const handlePress = () => {
    if (gameOver || isRolling) return;
    if (gameMode === "ai" && currentPlayer === 2) return;

    isRolling = true;
    render();

    setTimeout(() => {
      rollOnce(currentPlayer);
      isRolling = false;
      render();
      maybeAITurn();
    }, 1000);
  };

  const handleReset = () => {
    clearTimeout(aiTimeout);
    currentNumber = 100;
    currentPlayer = 1;
    gameOver = false;
    loser = null;
    lastRoll = null;
    history = [];
    currentBet = 0;
    showBettingScreen = (gameMode === "ai");
    persist();
    render();
    maybeAITurn();
  };

  const maybeAITurn = () => {
    clearTimeout(aiTimeout);
    if (gameMode === "ai" && currentPlayer === 2 && !gameOver && !isRolling) {
      aiTimeout = setTimeout(() => {
        isRolling = true;
        render();

        setTimeout(() => {
          rollOnce(2);
          isRolling = false;
          render();
        }, 1000);
      }, 200);
    }
  };

  const who = (p) => (gameMode === "ai" && p === 2) ? "AI" : `Player ${p}`;

  // ---------- UI ----------
  const renderHistory = () => {
    if (!history.length) {
      $historyCard.style.display = "none";
      return;
    }
    $historyCard.style.display = "block";
    $historyList.innerHTML = history.map(h => `
      <div class="histRow">
        <div style="font-weight:700;">${who(h.player)}</div>
        <div class="${h.roll === 1 ? "roll1" : ""}">Rolled: ${h.roll}</div>
      </div>
    `).join("");
  };

  const render = () => {
    renderHistory();

    // MENU
    if (gameMode === null) {
      $subtitle.textContent = "Choose your game mode";
      const goldClickable = gold < 5 ? 'onclick="window.__restoreGold()"' : "";
      const goldTitle = gold < 5 ? 'title="Tap to restore gold to 5"' : "";

      $screen.innerHTML = `
        <div class="center">
          <div class="gold" ${goldTitle} style="${gold < 5 ? "cursor:pointer;" : ""}" ${goldClickable}>ðŸª™ ${gold}</div>
          ${gold < 5 ? `<div class="hint">Tap the gold to restore it to 5</div>` : ``}
        </div>

        <div style="height:14px;"></div>

        <div class="stack">
          <button class="btn-primary" onclick="window.__startGame('pvp')">Player vs Player</button>
          <button class="btn-outline" onclick="window.__startGame('ai')" ${gold===0 ? "disabled" : ""}>Player vs AI</button>
        </div>

        <div class="hint center" style="margin-top:14px;">
          Take turns pressing the button. Don't roll a 1 or you lose!
          ${gold > 0 ? `<div style="margin-top:6px; color:#c58b00; font-weight:800;">Win against AI to double your bet!</div>` : ``}
        </div>
      `;
      return;
    }

    // BETTING screen (AI)
    if (showBettingScreen && gameMode === "ai") {
      $subtitle.textContent = "Choose your bet amount";
      const oneThird = Math.floor(gold / 3);
      const oneHalf = Math.floor(gold / 2);
      const allIn = gold;

      $screen.innerHTML = `
        <div class="center">
          <div class="gold">ðŸª™ ${gold}</div>
          <div class="hint">Your gold</div>
        </div>

        <div style="height:14px;"></div>

        <div class="stack">
          <button class="btn-outline" onclick="window.__selectBet(${oneThird})" ${oneThird===0 ? "disabled" : ""}>
            1/3 of Gold (ðŸª™ ${oneThird})
          </button>
          <button class="btn-outline" onclick="window.__selectBet(${oneHalf})" ${oneHalf===0 ? "disabled" : ""}>
            1/2 of Gold (ðŸª™ ${oneHalf})
          </button>
          <button class="btn-primary" onclick="window.__selectBet(${allIn})" ${allIn===0 ? "disabled" : ""}>
            All In! (ðŸª™ ${allIn})
          </button>
          <button class="btn-ghost" onclick="window.__backToMenu()">Back to Menu</button>
        </div>
      `;
      return;
    }

    // GAME screen
    $subtitle.textContent = "Take turns pressing. Don't roll a 1!";

    const turnText = gameOver
      ? "Game Over!"
      : (isRolling ? "Rolling..." : `${(gameMode === "ai" && currentPlayer === 2) ? "AI" : `Player ${currentPlayer}`}'s Turn`);

    const gameOverText = gameOver ? `
      <div class="turn" style="color:#c40000;">Game Over!</div>
      <div style="margin-top:6px;">
        ${(gameMode === "ai" && loser === 2) ? "AI" : `Player ${loser}`} rolled a 1 and loses!
      </div>
      <div style="margin-top:8px;" class="ok">
        ${
          gameMode === "ai"
            ? (loser === 1 ? "AI wins!" : "You win!")
            : `Player ${loser === 1 ? 2 : 1} wins!`
        }
      </div>
      <div style="margin-top:12px;">
        <button class="btn-primary" onclick="window.__resetRound()">Play Again</button>
        <button class="btn-ghost" onclick="window.__backToMenu()" style="margin-left:8px;">Menu</button>
      </div>
    ` : `
      <div class="turn">${turnText}</div>
      ${lastRoll && !isRolling ? `<div class="last">Last roll: ${lastRoll}</div>` : ``}
      <div style="margin-top:12px;">
        <button class="btn-ghost" onclick="window.__backToMenu()">Menu</button>
      </div>
    `;

    $screen.innerHTML = `
      ${gameMode === "ai" ? `
        <div class="center">
          <div class="gold small">ðŸª™ ${gold} gold</div>
          <div class="hint">Bet: ${currentBet} gold</div>
        </div>
        <div style="height:10px;"></div>
      ` : ``}

      <div class="center">
        <div class="hint">Current Number</div>
        <div class="bigNum">${currentNumber}</div>
      </div>

      <div style="height:16px;"></div>

      <div class="center">
        <button class="diceBtn" onclick="window.__press()" ${
          (gameOver || isRolling || (gameMode === "ai" && currentPlayer === 2)) ? "disabled" : ""
        }>
          <span class="${isRolling ? "spin" : ""}">ðŸŽ²</span>
        </button>
      </div>

      <div class="center" style="margin-top:16px;">
        ${gameOverText}
      </div>
    `;

    maybeAITurn();
  };

  // expose tiny handlers
  window.__startGame = startGame;
  window.__selectBet = selectBet;
  window.__press = handlePress;
  window.__resetRound = handleReset;
  window.__backToMenu = resetToMenu;
  window.__restoreGold = restoreGold;

  // service worker (offline-ish)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  render();
})();
</script>
</body>
</html>
